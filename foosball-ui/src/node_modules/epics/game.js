import { Subject } from "rxjs";
import { mergeMap, filter, mapTo } from "rxjs/operators";

import { Client } from "colyseus/colyseus.js";
const client = new Client("ws://localhost:7000");

export const gameEpic = action$ =>
  action$.pipe(
    filter(action => action.type === "JOIN_ROOM"),

    mergeMap(action => {
      const subject = new Subject();
      const room = client.join("standard", {
        standard: action.payload.lobbyName,
        scene: "bluesky"
      });

      room.onJoin.add(() => {
        console.log("joined");
      });

      room.onStateChange.add(state => {
        subject.next({
          type: "ROOM_STATE_CHANGE",
          payload: room.state
        });
      });
      return subject;
    })
  );
