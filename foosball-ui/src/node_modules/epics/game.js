import { Subject } from "rxjs";
import { mergeMap, filter, mapTo } from "rxjs/operators";

import { Client } from "colyseus/colyseus.js";
const client = new Client("ws://localhost:7000");

export const gameEpic = action$ =>
  action$
    .pipe(
      filter(action => action.type === "JOIN_ROOM"),

      mergeMap(action => {
        const subject = new Subject();
        const room = client.join("standard", {
          standard: action.payload.lobbyName,
          scene: "bluesky",
          creator: {
            colyseus_client_id: client.id,
            fb_client_id: action.payload.player.id,
            fb_client_name: action.payload.player.name
          }
        });

        room.onJoin.add(() => {});

        room.onStateChange.addOnce(state => {
          console.log("Room State Init", state);
          subject.next({
            type: "ROOM_STATE_INIT",
            payload: room.state
          });

          subject.next({
            type: "CHANGE_ROUTE",
            routeName: "lobby"
          });
        });

        room.onStateChange.add(state => {
          console.log("Room State Change", state);
        });

        return subject;
      })
    );
